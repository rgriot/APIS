---
title: 'APIS: An Auto-Adaptive Parentage Inference Software tolerant to missing parents'
author: |
  | Ronan GRIOT $^{1,2}$, François ALLAL $^{3}$, Marc VANDEPUTTE $^{2,3}$
  |
  | $^{1}$SYSAAF, Station LPGP/INRA, Campus de Beaulieu, Rennes, France
  | $^{2}$GABI, INRA, AgroParisTech, Université Paris-Saclay, France
  | $^{3}$MARBEC, Univ. Montpellier, Ifremer, CNRS, IRD, Palavas-les-Flots, France
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
vignette: |
  %\VignetteIndexEntry{Vignette Title} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.pos = 'ht !'
)
```

# Description
This package include all the functions to assign with APIS (Griot & al., 2019).
Parentage assignment is widely used for farmed and natural populations. As most of the likelihood software are based on simulation, the estimation of the simulation parameters is a key point for assignment reliability. Among those parameters, the proportion of missing parent is one of the most important. To avoid estimation of missing parents, we developed APIS (Auto-Adaptive Parentage Inference Software), based on observed average Mendelian transmission probabilities.

# Install and load the package
```{r load_packages, include=F}
devtools::install_github("rgriot/APIS")
library(APIS)
```
```{r, eval=F}
devtools::install_github("rgriot/APIS")
library(APIS)
```

If an error message occurs during the installation, use the following command :
```{r, eval=F}
devtools::install_github("rgriot/APIS", args = "--no-multiarch")
library(APIS)
```

\newpage

# Formate your data
APIS requires matrices of characters as inputs.
Each matrix has individuals as rows, markers as columns. The individual labels are set as rownames. Each cell is the genotype of one marker, coded "All1/All2". For example "A/A", "A/B", "B/B" for bi-allelic markers and "NA/NA" for missing value. For multi-allelic markers, use the generic coding "All1/All2".

```{r}
data("genotype_APIS")

head(off_full[,1:10])
rownames(off_full[1:6,])
```

\newpage

# Prepare the inputs
APIS main function requires 4 inputs :

  * off.genotype = matrix of offspring genotypes coded as explained above
  
  * sire.genotype = matrix of sires genotypes coded as explained above
  
  * dam.genotype = matrix of dams genotypes coded as explained above
  
  * error = accepted assignment error rate (What is the maximum error rate I accept in my assignment results ?)

```{r}
head(off_full[,1:10])
head(sire_full[,1:10])
head(dam_full[,1:10])
error <- 0.05 #I accept 5% of errors in the results
```

# Running the assignment
The main function to perform parentage assignment with APIS the "APIS" function.
Use the function as below, with default parameters for exclusion threshold and preselection of parents for maximizing the reliability.

```{r, eval = F}
result <- APIS(off.genotype = off_full,
               sire.genotype = sire_full,
               dam.genotype = dam_full,
               error = error)
```

# Analyse the results
APIS gives you 3 different outputs :
  
  * pedigree
  
  * log containing Mendelian transmission probabilities, mismatches and deltas for the first 3 parent pairs
  
  * graphs of the distributions of deltas, Mendelian transmission probabilities and mismatches

According to the graphs, you can change the thresholds to improve your assignment.

If you want to set up your threshold on Mendelian probabilities, use :

```{r, eval = F}
new.result <- personalThreshold(APIS.result = result,
                                method = 'Pmendel',
                                threshold = 0.7)
```

If you want to set up your threshold on mismatches, use :

```{r, eval = F}
new.result <- personalThreshold(APIS.result = result,
                                method = 'exclusion',
                                threshold = 5)
```

# Examples
## Full data
This example uses the full data provided by the package (Figure 1).

```{r, eval = F}
result <- APIS(off.genotype = off_full,
               sire.genotype = sire_full,
               dam.genotype = dam_full,
               error = 0.05)
```
```{r , echo=FALSE, fig.cap="APIS outputs calculated on 1000 offspring from 10 sires and 10 dams, genotyped on 400 markers", out.width = '70%', fig.align='center'}
knitr::include_graphics('D:/Data_RG/package_APIS/APIS/vignettes/fulldata_APIS.png')
```

When I look at the mismatch distributions, I prefer to use exclusion and allow for 5 mismatches (Figure 2).

```{r, eval = F}
new.result <- personalThreshold(APIS.result = result,
                                method = 'exclusion',
                                threshold = 5)
```

\newpage

```{r , echo=FALSE, fig.cap="APIS outputs based on mismatches calculated on 1000 offspring from 10 sires and 10 dams, genotyped on 400 markers", out.width = '70%', fig.align='center'}
knitr::include_graphics('D:/Data_RG/package_APIS/APIS/vignettes/fulldata_mismatch.png')
```

\newpage

## Degraded data
This example uses the degraded data provided by the package (Figure 3).

```{r, eval = F}
result <- APIS(off.genotype = off_degraded,
               sire.genotype = sire_degraded,
               dam.genotype = dam_degraded,
               error = 0.05)
```
In this situation, the theoretical assignment power is low and there are missing parents.
The distribution graphs do not give you more information about a new threshold value.

Thus, the better answer is to keep APIS results.

```{r , echo=FALSE, fig.cap="APIS outputs calculated on 1000 offspring from 5 sires (5 missing sires) and 10 dams, genotyped on 50 markers", out.width = '70%', fig.align='center'}
knitr::include_graphics('D:/Data_RG/package_APIS/APIS/vignettes/degradeddata_APIS.png')
```

# Other parameters of APIS function
APIS function can handle 2 other parameters :

  * exclusion.threshold : For exclusion procedure, the number of mismatches allowed by the user. Use default value for Mendelian transmission probability procedure.
  
  * preselect.Parent : Use of a parent preselection function based on Mendelian incompatibilities. Use default value to get the most accurate results. If a value is specified, this will increase computation time but can decrease assignment reliability.

# Acknowlegments
This work was partially financially supported in the GeneSea project (n° R FEA 4700 16 FA 100 0005) by the French Government and the European Union (EMFF, European Maritime and Fisheries Fund) at the "Appels à projets Innovants" managed by the FranceAgrimer Office. The doctoral scholarship of Ronan Griot was partially supported by the ANRT (doctoral scholarship n° 2017/0731) and SYSAAF.

# Annexe

```{r info}
print(sessionInfo(), locale=FALSE)
```
